<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.paladin.monitor.mapper.config.ConfigTerminalMapper">


    <select id="findStationDevice" resultType="com.paladin.monitor.service.config.vo.StationDeviceMonitorVO">
        SELECT
        a.id,
        a.`name` AS deviceName,
        b.`name` AS stationName,
        a.uid,
        a.`type`,
        b.is_third AS isThird
        FROM
        station_device a
        INNER JOIN station b ON a.station_id = b.id
        WHERE a.deleted = 0 AND b.deleted = 0
        <if test="query.name!=null and query.name!=''">
            AND (b.name like CONCAT('%',#{query.name},'%') OR b.pinyin_name like LOWER(CONCAT('%',#{query.name},'%')))
        </if>
        <if test="query.stationId!=null">
            AND b.id = #{query.stationId}
        </if>
        <if test="query.provinceCode!=null">
            AND b.province_code = #{query.provinceCode}
        </if>
        <if test="query.cityCode!=null">
            AND b.city_code = #{query.cityCode}
        </if>
        <if test="query.districtCode!=null">
            AND b.district_code = #{query.districtCode}
        </if>
        <if test="query.serverNode!=null and query.serverNode !=''">
            AND b.server_node = #{query.serverNode}
        </if>
        <if test="query.agencyLevel!=null">
            AND b.agency_level = #{query.agencyLevel}
        </if>
        <if test="query.isTest!=null">
            AND b.is_test = #{query.isTest}
        </if>
        <if test="query.enabled!=null">
            AND b.enabled = #{query.enabled} AND a.enabled = #{query.enabled}
        </if>
        <if test="permission!=null">
            AND b.is_test = 0 AND
            <trim prefix="(" suffix=")" prefixOverrides="OR">
                <if test="permission.provinceCode!=null">
                    OR b.province_code = #{permission.provinceCode}
                </if>
                <if test="permission.provinceCodes!=null">
                    OR b.province_code in
                    <foreach collection="permission.provinceCodes" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="permission.cityCode!=null">
                    OR b.city_code = #{permission.cityCode}
                </if>
                <if test="permission.cityCodes!=null">
                    OR b.city_code in
                    <foreach collection="permission.cityCodes" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="permission.districtCode!=null">
                    OR b.district_code = #{permission.districtCode}
                </if>
                <if test="permission.districtCodes!=null">
                    OR b.district_code in
                    <foreach collection="permission.districtCodes" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="permission.stationId!=null">
                    OR b.id = #{permission.stationId}
                </if>
                <if test="permission.stationIds!=null">
                    OR b.id in
                    <foreach collection="permission.stationIds" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
            </trim>
        </if>
        ORDER BY b.order_no DESC
    </select>


    <select id="findStationDeviceId" resultType="int">
        SELECT
        a.id
        FROM
        station_device a
        INNER JOIN station b ON a.station_id = b.id
        WHERE a.deleted = 0 AND b.deleted = 0
        <if test="query.name!=null and query.name!=''">
            AND (b.name like CONCAT('%',#{query.name},'%') OR b.pinyin_name like LOWER(CONCAT('%',#{query.name},'%')))
        </if>
        <if test="query.stationId!=null">
            AND b.id = #{query.stationId}
        </if>
        <if test="query.provinceCode!=null">
            AND b.province_code = #{query.provinceCode}
        </if>
        <if test="query.cityCode!=null">
            AND b.city_code = #{query.cityCode}
        </if>
        <if test="query.districtCode!=null">
            AND b.district_code = #{query.districtCode}
        </if>
        <if test="query.serverNode!=null and query.serverNode !=''">
            AND b.server_node = #{query.serverNode}
        </if>
        <if test="query.agencyLevel!=null">
            AND b.agency_level = #{query.agencyLevel}
        </if>
        <if test="query.isTest!=null">
            AND b.is_test = #{query.isTest}
        </if>
        <if test="query.enabled!=null">
            AND b.enabled = #{query.enabled} AND a.enabled = #{query.enabled}
        </if>

        <if test="permission!=null">
            AND b.is_test = 0 AND
            <trim prefix="(" suffix=")" prefixOverrides="OR">
                <if test="permission.provinceCode!=null">
                    OR b.province_code = #{permission.provinceCode}
                </if>
                <if test="permission.provinceCodes!=null">
                    OR b.province_code in
                    <foreach collection="permission.provinceCodes" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="permission.cityCode!=null">
                    OR b.city_code = #{permission.cityCode}
                </if>
                <if test="permission.cityCodes!=null">
                    OR b.city_code in
                    <foreach collection="permission.cityCodes" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="permission.districtCode!=null">
                    OR b.district_code = #{permission.districtCode}
                </if>
                <if test="permission.districtCodes!=null">
                    OR b.district_code in
                    <foreach collection="permission.districtCodes" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="permission.stationId!=null">
                    OR b.id = #{permission.stationId}
                </if>
                <if test="permission.stationIds!=null">
                    OR b.id in
                    <foreach collection="permission.stationIds" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
            </trim>
        </if>
        ORDER BY b.order_no DESC
    </select>


    <select id="findSimpleStationDevice" resultType="com.paladin.monitor.service.config.vo.Station2Device">
        SELECT
        a.id,
        a.`name`,
        a.station_id AS stationId,
        b.name AS stationName
        FROM station_device a INNER JOIN station b ON a.station_id = b.id
        WHERE a.deleted = 0 AND b.deleted = 0
        <if test="query.name!=null and query.name!=''">
            AND (b.name like CONCAT('%',#{query.name},'%') OR b.pinyin_name like LOWER(CONCAT('%',#{query.name},'%')))
        </if>
        <if test="query.stationId!=null">
            AND b.id = #{query.stationId}
        </if>
        <if test="query.provinceCode!=null">
            AND b.province_code = #{query.provinceCode}
        </if>
        <if test="query.cityCode!=null">
            AND b.city_code = #{query.cityCode}
        </if>
        <if test="query.districtCode!=null">
            AND b.district_code = #{query.districtCode}
        </if>
        <if test="query.serverNode!=null and query.serverNode !=''">
            AND b.server_node = #{query.serverNode}
        </if>
        <if test="query.agencyLevel!=null">
            AND b.agency_level = #{query.agencyLevel}
        </if>
        <if test="query.isTest!=null">
            AND b.is_test = #{query.isTest}
        </if>
        <if test="query.enabled!=null">
            AND b.enabled = #{query.enabled} AND a.enabled = #{query.enabled}
        </if>
        <if test="permission!=null">
            AND b.is_test = 0 AND
            <trim prefix="(" suffix=")" prefixOverrides="OR">
                <if test="permission.provinceCode!=null">
                    OR b.province_code = #{permission.provinceCode}
                </if>
                <if test="permission.provinceCodes!=null">
                    OR b.province_code in
                    <foreach collection="permission.provinceCodes" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="permission.cityCode!=null">
                    OR b.city_code = #{permission.cityCode}
                </if>
                <if test="permission.cityCodes!=null">
                    OR b.city_code in
                    <foreach collection="permission.cityCodes" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="permission.districtCode!=null">
                    OR b.district_code = #{permission.districtCode}
                </if>
                <if test="permission.districtCodes!=null">
                    OR b.district_code in
                    <foreach collection="permission.districtCodes" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="permission.stationId!=null">
                    OR b.id = #{permission.stationId}
                </if>
                <if test="permission.stationIds!=null">
                    OR b.id in
                    <foreach collection="permission.stationIds" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
            </trim>
        </if>
        ORDER BY b.order_no DESC
    </select>

    <select id="findStationDeviceServer" resultType="com.paladin.monitor.service.data.vo.Device2ServerNode">
        SELECT
        a.id,
        b.server_node AS serverNode
        FROM station_device a INNER JOIN station b ON a.station_id = b.id
        WHERE a.deleted = 0 AND b.deleted = 0
        <if test="query.name!=null and query.name!=''">
            AND (b.name like CONCAT('%',#{query.name},'%') OR b.pinyin_name like LOWER(CONCAT('%',#{query.name},'%')))
        </if>
        <if test="query.stationId!=null">
            AND b.id = #{query.stationId}
        </if>
        <if test="query.provinceCode!=null">
            AND b.province_code = #{query.provinceCode}
        </if>
        <if test="query.cityCode!=null">
            AND b.city_code = #{query.cityCode}
        </if>
        <if test="query.districtCode!=null">
            AND b.district_code = #{query.districtCode}
        </if>
        <if test="query.serverNode!=null and query.serverNode !=''">
            AND b.server_node = #{query.serverNode}
        </if>
        <if test="query.agencyLevel!=null">
            AND b.agency_level = #{query.agencyLevel}
        </if>
        <if test="query.isTest!=null">
            AND b.is_test = #{query.isTest}
        </if>
        <if test="query.enabled!=null">
            AND b.enabled = #{query.enabled} AND a.enabled = #{query.enabled}
        </if>
        <if test="permission!=null">
            AND b.is_test = 0 AND
            <trim prefix="(" suffix=")" prefixOverrides="OR">
                <if test="permission.provinceCode!=null">
                    OR b.province_code = #{permission.provinceCode}
                </if>
                <if test="permission.provinceCodes!=null">
                    OR b.province_code in
                    <foreach collection="permission.provinceCodes" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="permission.cityCode!=null">
                    OR b.city_code = #{permission.cityCode}
                </if>
                <if test="permission.cityCodes!=null">
                    OR b.city_code in
                    <foreach collection="permission.cityCodes" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="permission.districtCode!=null">
                    OR b.district_code = #{permission.districtCode}
                </if>
                <if test="permission.districtCodes!=null">
                    OR b.district_code in
                    <foreach collection="permission.districtCodes" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="permission.stationId!=null">
                    OR b.id = #{permission.stationId}
                </if>
                <if test="permission.stationIds!=null">
                    OR b.id in
                    <foreach collection="permission.stationIds" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
            </trim>
        </if>
        ORDER BY b.order_no DESC
    </select>
</mapper>