<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.paladin.monitor.mapper.data.DataAnalysisDayMapper">
    <insert id="insertBatch" parameterType="java.util.List">
        INSERT INTO data_analysis_day VALUES
        <foreach collection="list" item="item" index="index" separator=",">
            (#{item.day},#{item.terminalId},#{item.varId},#{item.maxValue},#{item.minValue},#{item.avgValue})
        </foreach>
    </insert>

    <insert id="insert" parameterType="com.paladin.monitor.model.data.DataAnalysisDay">
        INSERT INTO data_analysis_day VALUES (#{day},#{terminalId},#{varId},#{maxValue},#{minValue},#{avgValue})
    </insert>

    <select id="analyze4city" resultType="com.paladin.monitor.service.data.vo.DataDay">
        SELECT a.district_code AS `code`, MOD(c.day, 100) AS `day`, MAX(c.max_value) AS `maxValue`, MIN(c.min_value) AS `minValue`
        FROM station a
        LEFT JOIN station_device b ON a.id = b.station_id
        LEFT JOIN data_analysis_day c ON c.terminal_id = b.id
        WHERE a.deleted = 0 AND a.city_code = #{cityCode}
        AND b.deleted = 0 AND c.var_id = #{variableId} AND c.day &gt;= #{startDay} AND c.day &lt;= #{endDay}
        GROUP BY a.district_code, c.day ORDER BY `code` ASC, `day` ASC
    </select>

    <select id="analyze4district" resultType="com.paladin.monitor.service.data.vo.DataDay">
        SELECT b.id  AS `code`, MOD(c.day, 100) AS `day`, MAX(c.max_value) AS `maxValue`, MIN(c.min_value) AS `minValue`
        FROM station a
        LEFT JOIN station_device b ON a.id = b.station_id
        LEFT JOIN data_analysis_day c ON c.terminal_id = b.id
        WHERE a.deleted = 0 AND a.district_code = #{districtCode}
        AND b.deleted = 0 AND c.var_id = #{variableId} AND c.day &gt;= #{startDay} AND c.day &lt;= #{endDay}
        GROUP BY b.id, c.day ORDER BY `code` ASC, `day` ASC
    </select>


    <select id="analyze4station" resultType="com.paladin.monitor.service.data.vo.DataDay">
        SELECT b.id  AS `code`, MOD(c.day, 100) AS `day`, MAX(c.max_value) AS `maxValue`, MIN(c.min_value) AS `minValue`
        FROM station a
        LEFT JOIN station_device b ON a.id = b.station_id
        LEFT JOIN data_analysis_day c ON c.terminal_id = b.id
        WHERE a.deleted = 0 AND a.id = #{stationId}
        AND b.deleted = 0 AND c.var_id = #{variableId} AND c.day &gt;= #{startDay} AND c.day &lt;= #{endDay}
        GROUP BY b.id, c.day ORDER BY `code` ASC, `day` ASC
    </select>


    <select id="analyze4terminal" resultType="com.paladin.monitor.service.data.vo.DataDay">
        SELECT var_id  AS `code`, MOD(`day`, 100) AS `day`, max_value AS `maxValue`, min_value AS `minValue`, avg_value AS avgValue
        FROM data_analysis_day a
        WHERE terminal_id = #{terminalId} AND a.day &gt;= #{startDay} AND a.day &lt;= #{endDay} AND var_id IN
        <foreach collection="varIds" item="item" index="index" open="(" separator="," close=")">#{item}</foreach>
        GROUP BY var_id, `day` ORDER BY `code` ASC, `day` ASC
    </select>

    <select id="analyze4show" resultType="com.paladin.monitor.service.data.vo.DataDay4Show">
        SELECT a.var_id AS varId, a.day, MAX(a.max_value) AS `maxValue`, MIN(a.min_value) AS `minValue` FROM data_analysis_day a
        INNER JOIN station_device b ON a.terminal_id = b.id
        INNER JOIN station c ON b.station_id = c.id
        WHERE a.day &gt;= #{startDay} AND a.var_id IN
        <foreach collection="varIds" item="item" index="index" open="(" separator="," close=")">#{item}</foreach>
        <if test="query.name!=null and query.name!=''">
            AND (c.name like CONCAT('%',#{query.name},'%') OR c.pinyin_name like LOWER(CONCAT('%',#{query.name},'%')))
        </if>
        <if test="query.stationId!=null">
            AND c.id = #{query.stationId}
        </if>
        <if test="query.provinceCode!=null">
            AND c.province_code = #{query.provinceCode}
        </if>
        <if test="query.cityCode!=null">
            AND c.city_code = #{query.cityCode}
        </if>
        <if test="query.districtCode!=null">
            AND c.district_code = #{query.districtCode}
        </if>
        <if test="query.serverNode!=null and query.serverNode !=''">
            AND c.server_node = #{query.serverNode}
        </if>
        <if test="query.agencyLevel!=null">
            AND c.agency_level = #{query.agencyLevel}
        </if>
        <if test="query.isTest!=null">
            AND c.is_test = #{query.isTest}
        </if>
        <if test="query.enabled!=null">
            AND c.enabled = #{query.enabled} AND b.enabled = #{query.enabled}
        </if>
        <if test="permission!=null">
            AND c.is_test = 0 AND
            <trim prefix="(" suffix=")" prefixOverrides="OR">
                <if test="permission.provinceCode!=null">
                    OR c.province_code = #{permission.provinceCode}
                </if>
                <if test="permission.provinceCodes!=null">
                    OR c.province_code in
                    <foreach collection="permission.provinceCodes" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="permission.cityCode!=null">
                    OR c.city_code = #{permission.cityCode}
                </if>
                <if test="permission.cityCodes!=null">
                    OR c.city_code in
                    <foreach collection="permission.cityCodes" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="permission.districtCode!=null">
                    OR c.district_code = #{permission.districtCode}
                </if>
                <if test="permission.districtCodes!=null">
                    OR c.district_code in
                    <foreach collection="permission.districtCodes" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="permission.stationId!=null">
                    OR c.id = #{permission.stationId}
                </if>
                <if test="permission.stationIds!=null">
                    OR c.id in
                    <foreach collection="permission.stationIds" index="index" item="item" open="(" separator=","
                             close=")">
                        #{item}
                    </foreach>
                </if>
            </trim>
        </if>
        GROUP BY a.var_id, a.day
    </select>

</mapper>